<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products Management</title>
    <script src="dashboard.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        thead tr {
            background-color: #333;
            color: white;
        }
        th {
            position: relative;
        }
        .sort-buttons {
            display: inline-flex;
            flex-direction: row;
            margin-left: 8px;
            gap: 3px;
            vertical-align: middle;
        }
        .sort-btn {
            background: white;
            border: 1px solid #ccc;
            color: #333;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            transition: all 0.2s;
            line-height: 1;
            font-weight: bold;
        }
        .sort-btn:hover {
            background-color: #e3f2fd;
            border-color: #2196F3;
        }
        .sort-btn.active {
            background-color: #2196F3;
            color: white;
            border-color: #2196F3;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.4);
        }
        tbody tr:nth-child(odd) {
            background-color: #000;
            color: white;
        }
        tbody tr:nth-child(even) {
            background-color: #fff;
            color: black;
        }
        tbody tr:hover {
            opacity: 0.8;
        }
        .title-cell {
            position: relative;
            cursor: pointer;
        }
        .description-tooltip {
            display: none;
            position: absolute;
            background: #333;
            border: 2px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 300px;
            max-width: 400px;
            bottom: 100%;
            left: 0;
            margin-bottom: 5px;
            color: white;
            font-size: 14px;
            line-height: 1.5;
        }
        .title-cell:hover .description-tooltip {
            display: block;
        }
        .product-image {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border-radius: 4px;
            background-color: #f0f0f0;
            display: block;
            margin: 5px auto;
        }
        .images-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            padding: 5px;
        }
        .images-gallery img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 4px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
        }
        input[type="text"] {
            padding: 8px;
            margin: 5px;
        }
        input[type="submit"] {
            padding: 8px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        input[type="submit"]:hover {
            background-color: #45a049;
        }
        button {
            padding: 12px 30px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
        }
        button:hover {
            background-color: #0b7dda;
        }
        .error {
            color: red;
            padding: 10px;
        }
        #loading {
            padding: 20px;
            color: #666;
        }
        .search-box {
            text-align: center;
            margin: 15px 0;
        }
        #search-input {
            padding: 12px 20px;
            width: 350px;
            border: 2px solid #2196F3;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
        }
        #search-input:focus {
            border-color: #0b7dda;
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.3);
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 20px;
        }
        .pagination {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .pagination button {
            padding: 8px 12px;
            margin: 0;
            background-color: #fff;
            color: #2196F3;
            border: 1px solid #2196F3;
            cursor: pointer;
            min-width: 40px;
        }
        .pagination button:hover {
            background-color: #2196F3;
            color: white;
        }
        .pagination button.active {
            background-color: #2196F3;
            color: white;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page-size-selector select {
            padding: 8px;
            border: 1px solid #2196F3;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2 style="text-align: center;">Products Management</h2>
    <button onclick="loadProducts()">Tải danh sách sản phẩm</button>
    <div class="search-box">
        <input type="text" id="search-input" placeholder="Tìm kiếm theo tên sản phẩm..." oninput="searchProducts()" onchange="searchProducts()">
    </div>
    <div id="loading" style="text-align: center;">Đang tải...</div>
    <div id="error"></div>
    <div>
        <table>
            <thead>
                <tr>
                    <th>id</th>
                    <th>image</th>
                    <th>
                        title
                        <span class="sort-buttons">
                            <button class="sort-btn" onclick="sortBy('title', 'asc')" title="Sắp xếp tăng dần">↑</button>
                            <button class="sort-btn" onclick="sortBy('title', 'desc')" title="Sắp xếp giảm dần">↓</button>
                        </span>
                    </th>
                    <th>
                        price
                        <span class="sort-buttons">
                            <button class="sort-btn" onclick="sortBy('price', 'asc')" title="Sắp xếp tăng dần">↑</button>
                            <button class="sort-btn" onclick="sortBy('price', 'desc')" title="Sắp xếp giảm dần">↓</button>
                        </span>
                    </th>
                    <th>category</th>
                </tr>
            </thead>
            <tbody id="table-body">

            </tbody>
        </table>
        <div class="pagination-container">
            <div class="page-size-selector">
                <label>Hiển thị:</label>
                <select id="page-size" onchange="changePageSize()">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                </select>
                <span>sản phẩm/trang</span>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script>
        // Biến toàn cục lưu danh sách sản phẩm
        let allProducts = [];
        let filteredProducts = [];
        let currentPage = 1;
        let pageSize = 10;
        let currentSort = { column: null, direction: null };

        // Hàm getAll lấy tất cả sản phẩm từ API
        async function getAll() {
            try {
                const response = await fetch('https://api.escuelajs.co/api/v1/products');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const products = await response.json();
                console.log('Lấy dữ liệu thành công:', products.length, 'sản phẩm');
                
                return products;
            } catch (error) {
                console.error('Lỗi khi lấy dữ liệu:', error);
                throw error;
            }
        }

        // Hàm hiển thị sản phẩm lên bảng
        function displayProducts(products) {
            const tableBody = document.getElementById('table-body');
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            
            loading.style.display = 'none';
            errorDiv.innerHTML = '';
            tableBody.innerHTML = '';
            
            filteredProducts = products;
            
            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Không tìm thấy sản phẩm</td></tr>';
                renderPagination();
                return;
            }
            
            // Tính toán phân trang
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const paginatedProducts = products.slice(startIndex, endIndex);
            
            paginatedProducts.forEach(product => {
                const row = document.createElement('tr');
                
                // Tạo gallery cho tất cả hình ảnh
                let imagesHtml = '<div class="images-gallery">';
                if (product.images && Array.isArray(product.images) && product.images.length > 0) {
                    product.images.forEach(imageUrl => {
                        if (imageUrl) {
                            imagesHtml += `<img src="${imageUrl}" alt="${product.title}" referrerpolicy="no-referrer" loading="lazy">`;
                        }
                    });
                } else {
                    imagesHtml += '<span>No images</span>';
                }
                imagesHtml += '</div>';
                
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${imagesHtml}</td>
                    <td class="title-cell">
                        ${product.title}
                        <div class="description-tooltip"><strong>Mô tả:</strong><br>${product.description || 'Không có mô tả'}</div>
                    </td>
                    <td>$${product.price}</td>
                    <td>${product.category.name}</td>
                `;
                tableBody.appendChild(row);
            });
            
            renderPagination();
        }

        // Hàm render phân trang
        function renderPagination() {
            const paginationDiv = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredProducts.length / pageSize);
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Nút Previous
            html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>«</button>`;
            
            // Hiển thị số trang
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span>...</span>`;
                }
            }
            
            // Nút Next
            html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>»</button>`;
            
            paginationDiv.innerHTML = html;
        }

        // Hàm chuyển trang
        function goToPage(page) {
            const totalPages = Math.ceil(filteredProducts.length / pageSize);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayProducts(filteredProducts);
        }

        // Hàm thay đổi số sản phẩm mỗi trang
        function changePageSize() {
            const pageSizeSelect = document.getElementById('page-size');
            pageSize = parseInt(pageSizeSelect.value);
            currentPage = 1;
            displayProducts(filteredProducts);
        }

        // Hàm tải sản phẩm
        async function loadProducts() {
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const tableBody = document.getElementById('table-body');
            
            loading.style.display = 'block';
            errorDiv.innerHTML = '';
            tableBody.innerHTML = '';
            
            try {
                const products = await getAll();
                allProducts = products;
                displayProducts(products);
            } catch (error) {
                loading.style.display = 'none';
                errorDiv.innerHTML = `<div class="error">Không thể tải dữ liệu: ${error.message}</div>`;
            }
        }

        // Hàm sắp xếp
        function sortBy(column, direction) {
            // Nếu click vào nút đang active, bỏ sắp xếp
            if (currentSort.column === column && currentSort.direction === direction) {
                currentSort.column = null;
                currentSort.direction = null;
            } else {
                currentSort.column = column;
                currentSort.direction = direction;
            }
            
            // Cập nhật icon
            updateSortIcons();
            
            // Sắp xếp dữ liệu
            let sortedProducts = [...filteredProducts];
            
            if (currentSort.direction) {
                sortedProducts.sort((a, b) => {
                    let valueA, valueB;
                    
                    if (column === 'title') {
                        valueA = a.title.toLowerCase();
                        valueB = b.title.toLowerCase();
                    } else if (column === 'price') {
                        valueA = a.price;
                        valueB = b.price;
                    }
                    
                    if (currentSort.direction === 'asc') {
                        return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                    } else {
                        return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                    }
                });
            }
            
            currentPage = 1;
            displayProducts(sortedProducts);
        }
        
        // Cập nhật icon sắp xếp
        function updateSortIcons() {
            // Xóa tất cả class active
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Thêm class active cho nút đang sắp xếp
            if (currentSort.column && currentSort.direction) {
                const btn = document.querySelector(`.sort-btn[onclick="sortBy('${currentSort.column}', '${currentSort.direction}')"]`);
                if (btn) {
                    btn.classList.add('active');
                }
            }
        }

        // Hàm tìm kiếm sản phẩm
        function searchProducts() {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            currentPage = 1; // Reset về trang 1 khi tìm kiếm
            
            let filtered;
            if (searchTerm === '') {
                filtered = allProducts;
            } else {
                filtered = allProducts.filter(product => 
                    product.title.toLowerCase().includes(searchTerm)
                );
            }
            
            // Áp dụng lại sắp xếp nếu có
            if (currentSort.column && currentSort.direction) {
                filtered = [...filtered];
                filtered.sort((a, b) => {
                    let valueA, valueB;
                    
                    if (currentSort.column === 'title') {
                        valueA = a.title.toLowerCase();
                        valueB = b.title.toLowerCase();
                    } else if (currentSort.column === 'price') {
                        valueA = a.price;
                        valueB = b.price;
                    }
                    
                    if (currentSort.direction === 'asc') {
                        return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                    } else {
                        return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                    }
                });
            }
            
            displayProducts(filtered);
        }

        // Tự động tải sản phẩm khi trang được load
        window.onload = loadProducts;
    </script>
</body>
</html>
